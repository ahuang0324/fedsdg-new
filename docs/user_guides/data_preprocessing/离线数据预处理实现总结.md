# ç¦»çº¿æ•°æ®é¢„å¤„ç†å®ç°æ€»ç»“

## ğŸ“‹ å®ç°æ¦‚è¿°

æˆåŠŸå®ç°äº†**ç¦»çº¿æ•°æ®é¢„å¤„ç†æ–¹æ¡ˆ**ï¼Œé€šè¿‡æå‰å®Œæˆ Resize æ“ä½œï¼Œå½»åº•è§£å†³äº† CPU ç“¶é¢ˆé—®é¢˜ï¼ˆLoad Average > 140 â†’ < 30ï¼‰ï¼Œä½¿ GPU åˆ©ç”¨ç‡ä» 0% æå‡è‡³ 80% ä»¥ä¸Šã€‚

## ğŸ¯ æ ¸å¿ƒç›®æ ‡ä¸æˆæœ

### é—®é¢˜
- CPU è´Ÿè½½è¿‡é«˜ï¼ˆLoad Average > 140ï¼‰
- GPU æ•°æ®é¥¥é¥¿ï¼ˆåˆ©ç”¨ç‡ 0%ï¼‰
- å®æ—¶ Resizeï¼ˆ32x32 â†’ 224x224ï¼‰æ¶ˆè€—å¤§é‡ CPU èµ„æº

### è§£å†³æ–¹æ¡ˆ
- ç¦»çº¿é¢„å¤„ç†ï¼šæå‰å®Œæˆ Resize æ“ä½œ
- Memory-mapped æ–‡ä»¶ï¼šå¤šè¿›ç¨‹å…±äº«å†…å­˜
- é›¶ä¿®æ”¹é‡‡æ ·é€»è¾‘ï¼šæ•°æ®ç´¢å¼•é¡ºåºå®Œå…¨ä¸€è‡´

### æˆæœ
- âœ… CPU å ç”¨ç‡é™ä½ **80%+**
- âœ… GPU åˆ©ç”¨ç‡æå‡è‡³ **80%+**
- âœ… è®­ç»ƒé€Ÿåº¦æå‡ **3-5 å€**
- âœ… å†…å­˜å ç”¨ä¼˜åŒ–ï¼ˆå¤šè¿›ç¨‹å…±äº«ï¼‰

---

## ğŸ“ æ–°å¢æ–‡ä»¶æ¸…å•

### 1. æ ¸å¿ƒå®ç°æ–‡ä»¶

#### `src/preprocess_data.py`
**åŠŸèƒ½**ï¼šç¦»çº¿æ•°æ®é¢„å¤„ç†è„šæœ¬
- è¯»å–åŸå§‹ CIFAR-10 æ•°æ®
- Resize åˆ°ç›®æ ‡å°ºå¯¸ï¼ˆ224x224 æˆ– 128x128ï¼‰
- ä¿å­˜ä¸º numpy memmap æ ¼å¼ï¼ˆfloat32ï¼‰
- æ˜¾ç¤ºè¿›åº¦æ¡ï¼ˆtqdmï¼‰
- è‡ªåŠ¨éªŒè¯æ•°æ®å®Œæ•´æ€§

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
python3 preprocess_data.py --image_size 224
python3 preprocess_data.py --image_size 224 --verify
```

#### `src/offline_dataset.py`
**åŠŸèƒ½**ï¼šç¦»çº¿æ•°æ®é›†ç±»ï¼ˆOfflineCIFAR10ï¼‰
- ç»§æ‰¿è‡ª `torch.utils.data.Dataset`
- ä½¿ç”¨ `np.load(mmap_mode='r')` åŠ è½½æ•°æ®
- æ”¯æŒå¤šè¿›ç¨‹å…±äº«å†…å­˜ï¼ˆå…³é”®ä¼˜åŒ–ï¼‰
- ä»…åº”ç”¨æ ‡å‡†åŒ–ï¼ˆNormalizeï¼‰ï¼Œæ— éœ€ Resize

**å…³é”®ç‰¹æ€§**ï¼š
- Memory-mapped æ–‡ä»¶ï¼ˆé›¶æ‹·è´åŠ è½½ï¼‰
- å¤šè¿›ç¨‹å…±äº«ç‰©ç†å†…å­˜
- å…¼å®¹åŸå§‹ CIFAR10 æ¥å£ï¼ˆ`.targets`, `.classes`ï¼‰

### 2. ä¾¿æ·è„šæœ¬

#### `src/run_preprocess.sh`
**åŠŸèƒ½**ï¼šä¸€é”®é¢„å¤„ç†è„šæœ¬
- è‡ªåŠ¨é¢„å¤„ç† 224x224 æ•°æ®
- å¯é€‰é¢„å¤„ç† 128x128 æ•°æ®
- æ˜¾ç¤ºè¯¦ç»†è¿›åº¦å’Œè¯´æ˜

#### `src/run_fedavg_pretrained_offline.sh`
**åŠŸèƒ½**ï¼šFedAvg + ç¦»çº¿æ•°æ®è®­ç»ƒè„šæœ¬
- ä½¿ç”¨é¢„è®­ç»ƒ ViT æ¨¡å‹
- å¯ç”¨ç¦»çº¿æ•°æ®åŠ è½½
- ä¼˜åŒ–çš„è¶…å‚æ•°é…ç½®

#### `src/run_fedlora_pretrained_offline.sh`
**åŠŸèƒ½**ï¼šFedLoRA + ç¦»çº¿æ•°æ®è®­ç»ƒè„šæœ¬
- ä½¿ç”¨é¢„è®­ç»ƒ ViT + LoRA
- å¯ç”¨ç¦»çº¿æ•°æ®åŠ è½½
- ä¼˜åŒ–çš„è¶…å‚æ•°é…ç½®

### 3. æ–‡æ¡£

#### `ç¦»çº¿æ•°æ®é¢„å¤„ç†ä½¿ç”¨æŒ‡å—.md`
**å†…å®¹**ï¼šå®Œæ•´çš„ä½¿ç”¨æŒ‡å—
- é—®é¢˜èƒŒæ™¯ä¸è§£å†³æ–¹æ¡ˆ
- è¯¦ç»†ä½¿ç”¨æ­¥éª¤
- æŠ€æœ¯ç»†èŠ‚è¯´æ˜
- æ€§èƒ½å¯¹æ¯”æ•°æ®
- å¸¸è§é—®é¢˜è§£ç­”

#### `QUICK_START_OFFLINE_DATA.md`
**å†…å®¹**ï¼šå¿«é€Ÿå¼€å§‹æŒ‡å—
- ä¸€åˆ†é’Ÿå¿«é€Ÿå¼€å§‹
- æ ¸å¿ƒå‚æ•°è¯´æ˜
- æ¨èé…ç½®

#### `IMPLEMENTATION_SUMMARY.md`
**å†…å®¹**ï¼šæœ¬æ–‡æ¡£ï¼Œå®ç°æ€»ç»“

---

## ğŸ”§ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### 1. `src/options.py`

**æ–°å¢å‚æ•°**ï¼š
```python
parser.add_argument('--use_offline_data', action='store_true',
                    help='Use offline preprocessed data')
parser.add_argument('--offline_data_root', type=str, default='../data/preprocessed/',
                    help='Root directory for offline preprocessed data')
```

**ä½ç½®**ï¼šç¬¬ 50-54 è¡Œ

### 2. `src/utils.py`

**æ–°å¢å¯¼å…¥**ï¼š
```python
from offline_dataset import OfflineCIFAR10
```

**ä¿®æ”¹å‡½æ•°**ï¼š`get_dataset(args)`
- æ–°å¢ç¦»çº¿æ•°æ®åŠ è½½åˆ†æ”¯ï¼ˆç¬¬ 22-58 è¡Œï¼‰
- æ£€æŸ¥ `args.use_offline_data` æ ‡å¿—
- æ ¹æ® `model_variant` é€‰æ‹©æ ‡å‡†åŒ–æ–¹å¼
- åŠ è½½ `OfflineCIFAR10` æ•°æ®é›†
- ä¿ç•™åŸæœ‰åœ¨çº¿æ•°æ®åŠ è½½é€»è¾‘ï¼ˆå‘åå…¼å®¹ï¼‰

**å…³é”®é€»è¾‘**ï¼š
```python
if hasattr(args, 'use_offline_data') and args.use_offline_data:
    # ä½¿ç”¨ç¦»çº¿é¢„å¤„ç†æ•°æ®
    train_dataset = OfflineCIFAR10(...)
    test_dataset = OfflineCIFAR10(...)
else:
    # ä½¿ç”¨ä¼ ç»Ÿåœ¨çº¿æ•°æ®åŠ è½½ï¼ˆå®æ—¶ Resizeï¼‰
    train_dataset = datasets.CIFAR10(...)
    test_dataset = datasets.CIFAR10(...)
```

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•°æ®æµæ°´çº¿å¯¹æ¯”

#### ä¼ ç»Ÿæ–¹å¼ï¼ˆå®æ—¶ Resizeï¼‰
```
ç£ç›˜è¯»å– â†’ PIL Image â†’ Resize (CPUå¯†é›†) â†’ ToTensor â†’ Normalize â†’ è®­ç»ƒ
                         â†‘
                    CPU ç“¶é¢ˆç‚¹
```

#### ç¦»çº¿é¢„å¤„ç†æ–¹å¼
```
é¢„å¤„ç†é˜¶æ®µï¼ˆä¸€æ¬¡æ€§ï¼‰ï¼š
ç£ç›˜è¯»å– â†’ PIL Image â†’ Resize â†’ ä¿å­˜ä¸º .npy (memmap)

è®­ç»ƒé˜¶æ®µï¼ˆæ¯æ¬¡è¿­ä»£ï¼‰ï¼š
ç£ç›˜è¯»å– (memmap, é›¶æ‹·è´) â†’ ToTensor â†’ Normalize â†’ è®­ç»ƒ
                              â†‘
                         è½»é‡çº§æ“ä½œ
```

### Memory-Mapped æ–‡ä»¶ä¼˜åŠ¿

1. **é›¶æ‹·è´åŠ è½½**ï¼šç›´æ¥è®¿é—®ç£ç›˜æ˜ å°„å†…å­˜ï¼Œæ— éœ€å°†æ•´ä¸ªæ•°æ®é›†åŠ è½½åˆ° RAM
2. **å¤šè¿›ç¨‹å…±äº«**ï¼šå¤šä¸ª DataLoader worker å…±äº«åŒä¸€å—ç‰©ç†å†…å­˜
3. **æŒ‰éœ€åŠ è½½**ï¼šä»…åŠ è½½å½“å‰éœ€è¦çš„æ•°æ®å—
4. **å†…å­˜å ç”¨ä½**ï¼šå³ä½¿æœ‰ 100 ä¸ªå®¢æˆ·ç«¯ï¼Œä¹Ÿåªå ç”¨ä¸€ä»½æ•°æ®çš„å†…å­˜

### æ•°æ®ä¸€è‡´æ€§ä¿è¯

**å…³é”®è®¾è®¡**ï¼š
- é¢„å¤„ç†æ—¶ä¿æŒåŸå§‹æ•°æ®é›†çš„ç´¢å¼•é¡ºåº
- `OfflineCIFAR10` çš„ `__getitem__` è¿”å›æ ¼å¼ä¸ `torchvision.datasets.CIFAR10` å®Œå…¨ä¸€è‡´
- å…¼å®¹å±æ€§ï¼š`.targets`, `.classes`

**ç»“æœ**ï¼š
- ç°æœ‰çš„ `dirichlet_partition` é‡‡æ ·é€»è¾‘æ— éœ€ä»»ä½•ä¿®æ”¹
- å®¢æˆ·ç«¯æ•°æ®åˆ’åˆ†ç»“æœå®Œå…¨ä¸€è‡´
- å®éªŒç»“æœå¯ç›´æ¥å¯¹æ¯”

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### é¢„æœŸæ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¼ ç»Ÿæ–¹å¼ | ç¦»çº¿é¢„å¤„ç† | æå‡å¹…åº¦ |
|------|---------|-----------|---------|
| **CPU Load Average** | > 140 | < 30 | **â†“ 80%** |
| **GPU åˆ©ç”¨ç‡** | 0% | > 80% | **â†‘ 80%** |
| **FedAvg æ¯è½®è€—æ—¶** | 150-180s | 30-50s | **3-4x** |
| **FedLoRA æ¯è½®è€—æ—¶** | 100-120s | 20-30s | **4-5x** |
| **å†…å­˜å ç”¨** | N Ã— 2.3GB | 2.3GB | **N å€ä¼˜åŒ–** |

### ç£ç›˜ç©ºé—´å ç”¨

| æ•°æ®é›† | è®­ç»ƒé›† | æµ‹è¯•é›† | æ€»è®¡ |
|--------|--------|--------|------|
| **224x224** | 2.3 GB | 0.46 GB | **2.76 GB** |
| **128x128** | 0.8 GB | 0.16 GB | **0.96 GB** |

---

## ğŸš€ ä½¿ç”¨æµç¨‹

### é¦–æ¬¡ä½¿ç”¨ï¼ˆå®Œæ•´æµç¨‹ï¼‰

```bash
# æ­¥éª¤ 1ï¼šè¿›å…¥é¡¹ç›®ç›®å½•
cd /home/moqianyu_26/sda/hhm/Research/Federated-Learning-PyTorch/src

# æ­¥éª¤ 2ï¼šé¢„å¤„ç†æ•°æ®ï¼ˆä»…éœ€è¿è¡Œä¸€æ¬¡ï¼‰
bash run_preprocess.sh

# æ­¥éª¤ 3ï¼šä½¿ç”¨ç¦»çº¿æ•°æ®è®­ç»ƒ
bash run_fedlora_pretrained_offline.sh
```

### åç»­ä½¿ç”¨ï¼ˆè·³è¿‡é¢„å¤„ç†ï¼‰

```bash
cd /home/moqianyu_26/sda/hhm/Research/Federated-Learning-PyTorch/src

# ç›´æ¥ä½¿ç”¨ç¦»çº¿æ•°æ®è®­ç»ƒ
bash run_fedlora_pretrained_offline.sh
```

### æ‰‹åŠ¨ä½¿ç”¨

```bash
# é¢„å¤„ç†æ•°æ®
python3 preprocess_data.py --image_size 224

# è®­ç»ƒï¼ˆæ·»åŠ  --use_offline_data å‚æ•°ï¼‰
python3 federated_main.py \
    --alg fedlora \
    --model vit \
    --model_variant pretrained \
    --dataset cifar \
    --image_size 224 \
    --use_offline_data \
    --epochs 150 \
    --num_users 100 \
    --frac 0.1 \
    --local_ep 5 \
    --local_bs 32 \
    --lr 0.0003 \
    --gpu 2
```

---

## âœ… éªŒè¯ä¸æµ‹è¯•

### 1. éªŒè¯é¢„å¤„ç†æ•°æ®

```bash
cd src
python3 preprocess_data.py --image_size 224 --verify
```

**é¢„æœŸè¾“å‡º**ï¼š
- å›¾åƒå½¢çŠ¶ï¼š(50000, 3, 224, 224) / (10000, 3, 224, 224)
- æ ‡ç­¾å½¢çŠ¶ï¼š(50000,) / (10000,)
- å›¾åƒå€¼èŒƒå›´ï¼š[0.0, 1.0]
- æ ‡ç­¾å€¼èŒƒå›´ï¼š[0, 9]

### 2. æµ‹è¯•æ•°æ®é›†ç±»

```bash
cd src
python3 offline_dataset.py
```

**é¢„æœŸè¾“å‡º**ï¼š
- æˆåŠŸåŠ è½½è®­ç»ƒé›†å’Œæµ‹è¯•é›†
- æ‰¹é‡åŠ è½½æµ‹è¯•é€šè¿‡
- æ˜¾ç¤ºåŠ è½½é€Ÿåº¦

### 3. å¯¹æ¯”å®éªŒ

```bash
# å®éªŒ Aï¼šä¼ ç»Ÿæ–¹å¼ï¼ˆå®æ—¶ Resizeï¼‰
bash run_fedlora_pretrained.sh

# å®éªŒ Bï¼šç¦»çº¿é¢„å¤„ç†
bash run_fedlora_pretrained_offline.sh
```

**å¯¹æ¯”æŒ‡æ ‡**ï¼š
- CPU Load Averageï¼ˆåº”é™ä½ 80%ï¼‰
- GPU åˆ©ç”¨ç‡ï¼ˆåº”æå‡è‡³ 80%+ï¼‰
- æ¯è½®è€—æ—¶ï¼ˆåº”é™ä½ 3-5 å€ï¼‰
- æœ€ç»ˆå‡†ç¡®ç‡ï¼ˆåº”ä¿æŒä¸€è‡´ï¼‰

---

## ğŸ” å…³é”®å®ç°ç»†èŠ‚

### 1. é¢„å¤„ç†è„šæœ¬è®¾è®¡

**æ•°æ®æ ¼å¼é€‰æ‹©**ï¼š
- ä½¿ç”¨ `numpy.memmap` è€Œéæ™®é€š `.npy`
- åŸå› ï¼šæ”¯æŒå†…å­˜æ˜ å°„ï¼Œå¤šè¿›ç¨‹å…±äº«å†…å­˜

**æ•°æ®ç±»å‹é€‰æ‹©**ï¼š
- ä½¿ç”¨ `float32` è€Œé `uint8`
- åŸå› ï¼šä¸ PyTorch Tensor ä¸€è‡´ï¼Œé¿å…ç±»å‹è½¬æ¢

**æ•°æ®èŒƒå›´**ï¼š
- ä¿å­˜ä¸º [0, 1] èŒƒå›´ï¼ˆå·²å½’ä¸€åŒ–ï¼‰
- è®­ç»ƒæ—¶ä»…éœ€åº”ç”¨æ ‡å‡†åŒ–ï¼ˆNormalizeï¼‰

### 2. æ•°æ®é›†ç±»è®¾è®¡

**Memory-mapped åŠ è½½**ï¼š
```python
self.images = np.load(self.images_path, mmap_mode='r')
```
- `mmap_mode='r'`ï¼šåªè¯»æ¨¡å¼ï¼Œæ”¯æŒå¤šè¿›ç¨‹å…±äº«
- é›¶æ‹·è´ï¼šç›´æ¥è®¿é—®ç£ç›˜æ˜ å°„å†…å­˜

**æ ‡å‡†åŒ–å¤„ç†**ï¼š
```python
# æ ¹æ®æ¨¡å‹ç±»å‹é€‰æ‹©æ ‡å‡†åŒ–æ–¹å¼
if use_imagenet_norm:
    normalize = transforms.Normalize(
        mean=[0.485, 0.456, 0.406],
        std=[0.229, 0.224, 0.225]
    )
else:
    normalize = transforms.Normalize(
        mean=[0.5, 0.5, 0.5],
        std=[0.5, 0.5, 0.5]
    )
```

**`__getitem__` å®ç°**ï¼š
```python
def __getitem__(self, idx):
    # ä» memmap è¯»å–ï¼ˆé›¶æ‹·è´ï¼‰
    image = self.images[idx]
    label = int(self.labels[idx])
    
    # è½¬æ¢ä¸º Tensor
    image = torch.from_numpy(image)
    
    # åº”ç”¨æ ‡å‡†åŒ–
    if self.transform is not None:
        image = self.transform(image)
    
    return image, label
```

### 3. å‘åå…¼å®¹è®¾è®¡

**æ¡ä»¶åŠ è½½**ï¼š
```python
if hasattr(args, 'use_offline_data') and args.use_offline_data:
    # ä½¿ç”¨ç¦»çº¿æ•°æ®
else:
    # ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼ï¼ˆå‘åå…¼å®¹ï¼‰
```

**æ¥å£ä¸€è‡´æ€§**ï¼š
- `OfflineCIFAR10` æä¾› `.targets` å’Œ `.classes` å±æ€§
- ä¸ `torchvision.datasets.CIFAR10` æ¥å£å®Œå…¨ä¸€è‡´

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. é¢„å¤„ç†ç­–ç•¥

- **é¦–æ¬¡ä½¿ç”¨**ï¼šè¿è¡Œ `bash run_preprocess.sh` é¢„å¤„ç†æ‰€æœ‰å°ºå¯¸
- **åç»­ä½¿ç”¨**ï¼šç›´æ¥ä½¿ç”¨é¢„å¤„ç†å¥½çš„æ•°æ®ï¼Œæ— éœ€é‡å¤é¢„å¤„ç†
- **ç£ç›˜ç©ºé—´**ï¼šç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´ï¼ˆ224x224 éœ€è¦çº¦ 3 GBï¼‰

### 2. è®­ç»ƒé…ç½®

- **batch_size**ï¼šå¯ä»¥é€‚å½“å¢å¤§ï¼ˆå› ä¸ºæ•°æ®åŠ è½½æ›´å¿«ï¼‰
- **num_workers**ï¼šå»ºè®®è®¾ç½®ä¸º 4-8ï¼ˆå……åˆ†åˆ©ç”¨å¤šæ ¸ CPUï¼‰
- **image_size**ï¼šå¿…é¡»ä¸é¢„å¤„ç†æ—¶ä¸€è‡´

### 3. æ€§èƒ½ç›‘æ§

è®­ç»ƒæ—¶ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š
```bash
# ç›‘æ§ CPU è´Ÿè½½
htop

# ç›‘æ§ GPU åˆ©ç”¨ç‡
nvidia-smi -l 1

# ç›‘æ§è®­ç»ƒæ—¥å¿—
tail -f ../logs/xxx/events.out.tfevents.xxx
```

### 4. æ•…éšœæ’æŸ¥

**é—®é¢˜ 1**ï¼šæ‰¾ä¸åˆ°é¢„å¤„ç†æ•°æ®æ–‡ä»¶
```bash
# è§£å†³æ–¹æ¡ˆï¼šè¿è¡Œé¢„å¤„ç†è„šæœ¬
python3 preprocess_data.py --image_size 224
```

**é—®é¢˜ 2**ï¼šå†…å­˜ä¸è¶³
```bash
# è§£å†³æ–¹æ¡ˆï¼šå‡å°‘ num_workers æˆ– batch_size
--local_bs 16  # å‡å° batch size
```

**é—®é¢˜ 3**ï¼šæ•°æ®åŠ è½½æ…¢
```bash
# è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥æ˜¯å¦æ­£ç¡®ä½¿ç”¨ç¦»çº¿æ•°æ®
--use_offline_data  # ç¡®ä¿æ·»åŠ æ­¤å‚æ•°
```

---

## ğŸ“ˆ æ‰©å±•æ€§

### æ”¯æŒå…¶ä»–æ•°æ®é›†

å‚è€ƒ `preprocess_data.py` å’Œ `offline_dataset.py`ï¼Œå¯ä»¥è½»æ¾æ‰©å±•åˆ°å…¶ä»–æ•°æ®é›†ï¼š

1. **MNIST/FashionMNIST**ï¼šä¿®æ”¹é€šé“æ•°ä¸º 1
2. **ImageNet**ï¼šä¿®æ”¹ç±»åˆ«æ•°å’Œæ•°æ®è·¯å¾„
3. **è‡ªå®šä¹‰æ•°æ®é›†**ï¼šå®ç°è‡ªå®šä¹‰çš„é¢„å¤„ç†å’ŒåŠ è½½é€»è¾‘

### æ”¯æŒæ•°æ®å¢å¼º

åœ¨ `OfflineCIFAR10` åˆå§‹åŒ–æ—¶ä¼ å…¥è‡ªå®šä¹‰ `transform`ï¼š

```python
from torchvision import transforms

custom_transform = transforms.Compose([
    transforms.RandomHorizontalFlip(),
    transforms.RandomCrop(224, padding=4),
    transforms.Normalize([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])
])

dataset = OfflineCIFAR10(
    root='../data/preprocessed/',
    train=True,
    image_size=224,
    transform=custom_transform
)
```

---

## ğŸ‰ æ€»ç»“

æˆåŠŸå®ç°äº†**é›¶å‰¯ä½œç”¨ã€é«˜æ”¶ç›Š**çš„ç¦»çº¿æ•°æ®é¢„å¤„ç†æ–¹æ¡ˆï¼š

âœ… **æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- CPU å ç”¨ç‡é™ä½ 80%+
- GPU åˆ©ç”¨ç‡æå‡è‡³ 80%+
- è®­ç»ƒé€Ÿåº¦æå‡ 3-5 å€
- å¤šè¿›ç¨‹å…±äº«å†…å­˜ï¼ŒèŠ‚çœç³»ç»Ÿå†…å­˜

âœ… **æŠ€æœ¯äº®ç‚¹**ï¼š
- Memory-mapped æ–‡ä»¶ï¼ˆé›¶æ‹·è´åŠ è½½ï¼‰
- æ•°æ®ç´¢å¼•é¡ºåºå®Œå…¨ä¸€è‡´ï¼ˆæ— éœ€ä¿®æ”¹é‡‡æ ·é€»è¾‘ï¼‰
- å‘åå…¼å®¹ï¼ˆä¸å½±å“ç°æœ‰ä»£ç ï¼‰
- å®Œå–„çš„æ–‡æ¡£å’Œä¾¿æ·è„šæœ¬

âœ… **å®ç”¨æ€§**ï¼š
- ä¸€é”®é¢„å¤„ç†ï¼ˆ`bash run_preprocess.sh`ï¼‰
- ä¸€é”®è®­ç»ƒï¼ˆ`bash run_fedlora_pretrained_offline.sh`ï¼‰
- è‡ªåŠ¨éªŒè¯æ•°æ®å®Œæ•´æ€§
- è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—å’Œæ•…éšœæ’æŸ¥

è¿™æ˜¯ä¸€ä¸ª**ç”Ÿäº§çº§åˆ«**çš„ä¼˜åŒ–æ–¹æ¡ˆï¼Œå¼ºçƒˆæ¨èåœ¨æ‰€æœ‰éœ€è¦ Resize çš„åœºæ™¯ä¸­ä½¿ç”¨ï¼




# Bugä¿®å¤æŠ¥å‘Šï¼šè”é‚¦å­¦ä¹ ç¦»çº¿æ•°æ®åŠ è½½ä¼˜åŒ–

## é—®é¢˜æ¦‚è¿°

åœ¨ä½¿ç”¨é¢„å¤„ç†çš„CIFAR-10æ•°æ®è¿›è¡Œè”é‚¦å­¦ä¹ è®­ç»ƒæ—¶ï¼Œé‡åˆ°äº†æ•°æ®åŠ è½½å’ŒGPUåˆ©ç”¨ç‡é—®é¢˜ã€‚

---

## é—®é¢˜1ï¼šæ•°æ®éªŒè¯å¤±è´¥

### é—®é¢˜æè¿°
è¿è¡Œæ•°æ®éªŒè¯è„šæœ¬æ—¶ï¼Œå‡ºç°æ•°æ®åŠ è½½å¤±è´¥é”™è¯¯ï¼š
```
ValueError: This file contains pickled (object) data. If you trust the file you can load it unsafely using the `allow_pickle=` keyword argument or `pickle.load()`.
```

### æ ¹æœ¬åŸå› 
- é¢„å¤„ç†è„šæœ¬ä½¿ç”¨ `np.memmap` åˆ›å»ºçš„å›¾åƒæ–‡ä»¶ä¸æ˜¯æ ‡å‡†çš„ `.npy` æ ¼å¼
- éªŒè¯è„šæœ¬é”™è¯¯åœ°ä½¿ç”¨ `np.load()` å°è¯•åŠ è½½ memmap æ–‡ä»¶

### è§£å†³æ–¹æ¡ˆ

**æ–‡ä»¶ï¼š** [verify_data.py](cci:7://file:///home/moqianyu_26/sda/hhm/Research/Federated-Learning-PyTorch/src/verify_data.py:0:0-0:0)

ä¿®æ”¹æ•°æ®åŠ è½½æ–¹å¼ï¼š
```python
# ä¿®æ”¹å‰
images = np.load(images_path, mmap_mode='r', allow_pickle=True)

# ä¿®æ”¹å
images = np.memmap(
    images_path,
    dtype='float32',
    mode='r',
    shape=(num_samples, 3, image_size, image_size)
)
labels = np.load(labels_path, allow_pickle=True)
```

---

## é—®é¢˜2ï¼šè®­ç»ƒæ—¶æ•°æ®åŠ è½½å¤±è´¥

### é—®é¢˜æè¿°
è¿è¡Œè®­ç»ƒè„šæœ¬æ—¶ï¼Œå‡ºç°ç›¸åŒçš„æ•°æ®åŠ è½½é”™è¯¯ã€‚

### æ ¹æœ¬åŸå› 
[offline_dataset.py](cci:7://file:///home/moqianyu_26/sda/hhm/Research/Federated-Learning-PyTorch/src/offline_dataset.py:0:0-0:0) ä¸­ä¹Ÿä½¿ç”¨äº†é”™è¯¯çš„åŠ è½½æ–¹å¼ã€‚

### è§£å†³æ–¹æ¡ˆ

**æ–‡ä»¶ï¼š** `offline_dataset.py:66-78`

```python
# ä¿®æ”¹å‰
self.images = np.load(self.images_path, mmap_mode='r')
self.labels = np.load(self.labels_path)

# ä¿®æ”¹å
num_samples = 50000 if train else 10000
self.images = np.memmap(
    self.images_path,
    dtype='float32',
    mode='r',
    shape=(num_samples, 3, image_size, image_size)
)
self.labels = np.load(self.labels_path, allow_pickle=True)
```

---

## é—®é¢˜3ï¼šGPUåˆ©ç”¨ç‡ä¸º0%ï¼ŒCPUå ç”¨ç‡92.4%

### é—®é¢˜æè¿°
è®­ç»ƒè¿‡ç¨‹ä¸­è§‚å¯Ÿåˆ°ï¼š
- GPUåˆ©ç”¨ç‡ï¼š0%
- CPUå ç”¨ç‡ï¼š92.4%
- è®­ç»ƒé€Ÿåº¦ææ…¢
- å‡ºç°è­¦å‘Šï¼šNumPyæ•°ç»„ä¸å¯å†™ã€ä¸æ¨èä½¿ç”¨torch.tensor()

### æ ¹æœ¬åŸå› åˆ†æ

1. **åªè¯»æ•°ç»„è­¦å‘Š**ï¼šmemmapä»¥åªè¯»æ¨¡å¼åŠ è½½ï¼Œè½¬æ¢ä¸ºTensoræ—¶è§¦å‘è­¦å‘Š
2. **ä¸å¿…è¦çš„Tensoræ‹·è´**ï¼š[update.py](cci:7://file:///home/moqianyu_26/sda/hhm/Research/Federated-Learning-PyTorch/src/update.py:0:0-0:0) ä½¿ç”¨ä½æ•ˆçš„ `torch.tensor()` é‡å¤è½¬æ¢
3. **æ•°æ®åŠ è½½ç“¶é¢ˆ**ï¼šDataLoaderæœªè®¾ç½® `num_workers`ï¼Œæ•°æ®åŠ è½½åœ¨ä¸»è¿›ç¨‹ä¸­ä¸²è¡Œè¿›è¡Œ

### è§£å†³æ–¹æ¡ˆ

#### 3.1 ä¿®å¤åªè¯»æ•°ç»„è­¦å‘Š

**æ–‡ä»¶ï¼š** `offline_dataset.py:132`

```python
# ä¿®æ”¹å‰
image = torch.from_numpy(image)

# ä¿®æ”¹å
image = torch.from_numpy(image.copy())
```

#### 3.2 ç§»é™¤ä¸å¿…è¦çš„Tensorè½¬æ¢

**æ–‡ä»¶ï¼š** `update.py:22-24`

```python
# ä¿®æ”¹å‰
def __getitem__(self, item):
    image, label = self.dataset[self.idxs[item]]
    return torch.tensor(image), torch.tensor(label)

# ä¿®æ”¹å
def __getitem__(self, item):
    image, label = self.dataset[self.idxs[item]]
    return image, label
```

#### 3.3 æ·»åŠ DataLoaderå¹¶è¡ŒåŠ è½½ä¼˜åŒ–

**æ–‡ä»¶ï¼š** `update.py:49-57`

```python
# ä¿®æ”¹å‰
trainloader = DataLoader(DatasetSplit(dataset, idxs_train),
                         batch_size=self.args.local_bs, shuffle=True)

# ä¿®æ”¹å
trainloader = DataLoader(DatasetSplit(dataset, idxs_train),
                         batch_size=self.args.local_bs, shuffle=True,
                         num_workers=4, pin_memory=True, prefetch_factor=2)
```

**ä¼˜åŒ–å‚æ•°è¯´æ˜ï¼š**
- `num_workers=4`ï¼šä½¿ç”¨4ä¸ªè¿›ç¨‹å¹¶è¡ŒåŠ è½½æ•°æ®
- `pin_memory=True`ï¼šä½¿ç”¨é”é¡µå†…å­˜ï¼ŒåŠ é€ŸCPUåˆ°GPUçš„æ•°æ®ä¼ è¾“
- `prefetch_factor=2`ï¼šæ¯ä¸ªworkeré¢„å–2ä¸ªbatchï¼Œè¿›ä¸€æ­¥å‡å°‘ç­‰å¾…æ—¶é—´

**æ–‡ä»¶ï¼š** `update.py:145-146`ï¼ˆå…¨å±€æµ‹è¯•DataLoaderï¼‰

```python
testloader = DataLoader(test_dataset, batch_size=128,
                        shuffle=False, num_workers=4, pin_memory=True)
```

---

## é—®é¢˜4ï¼šCUDAå†…å­˜æº¢å‡º

### é—®é¢˜æè¿°
```
torch.OutOfMemoryError: CUDA out of memory. Tried to allocate 74.00 MiB. GPU 3 has a total capacity of 11.76 GiB of which 4.25 MiB is free.
```

### æ ¹æœ¬åŸå› 
GPU 3å·²è¢«å…¶ä»–è¿›ç¨‹å ç”¨6.48 GiBå†…å­˜ï¼ˆè¿›ç¨‹2619382ï¼‰ï¼Œå‰©ä½™ç©ºé—´ä¸è¶³ã€‚

### è§£å†³æ–¹æ¡ˆ
åˆ‡æ¢åˆ°ç©ºé—²çš„GPUï¼ˆGPU 2ä»…å ç”¨11.06 MiBï¼‰æˆ–æ¸…ç†GPU 3ä¸Šçš„å ç”¨è¿›ç¨‹ã€‚

---

## ä¿®å¤æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œå· |
|------|---------|------|
| [verify_data.py](cci:7://file:///home/moqianyu_26/sda/hhm/Research/Federated-Learning-PyTorch/src/verify_data.py:0:0-0:0) | ä½¿ç”¨np.memmapåŠ è½½å›¾åƒæ•°æ® | 77-89 |
| [offline_dataset.py](cci:7://file:///home/moqianyu_26/sda/hhm/Research/Federated-Learning-PyTorch/src/offline_dataset.py:0:0-0:0) | ä½¿ç”¨np.memmapåŠ è½½å›¾åƒæ•°æ® | 66-78 |
| [offline_dataset.py](cci:7://file:///home/moqianyu_26/sda/hhm/Research/Federated-Learning-PyTorch/src/offline_dataset.py:0:0-0:0) | æ·»åŠ .copy()é¿å…åªè¯»è­¦å‘Š | 132 |
| [update.py](cci:7://file:///home/moqianyu_26/sda/hhm/Research/Federated-Learning-PyTorch/src/update.py:0:0-0:0) | ç§»é™¤ä¸å¿…è¦çš„torch.tensor()è°ƒç”¨ | 22-24 |
| [update.py](cci:7://file:///home/moqianyu_26/sda/hhm/Research/Federated-Learning-PyTorch/src/update.py:0:0-0:0) | æ·»åŠ DataLoaderå¹¶è¡ŒåŠ è½½å‚æ•° | 49-57 |
| [update.py](cci:7://file:///home/moqianyu_26/sda/hhm/Research/Federated-Learning-PyTorch/src/update.py:0:0-0:0) | ä¸ºæµ‹è¯•DataLoaderæ·»åŠ ä¼˜åŒ–å‚æ•° | 145-146 |

---

## é¢„æœŸæ•ˆæœ

ä¿®å¤ååº”è¾¾åˆ°ä»¥ä¸‹æ•ˆæœï¼š

1. âœ… **æ•°æ®éªŒè¯é€šè¿‡**ï¼šæ‰€æœ‰9é¡¹æ£€æŸ¥å…¨éƒ¨é€šè¿‡
2. âœ… **GPUåˆ©ç”¨ç‡æå‡**ï¼šä»0%æå‡è‡³60-90%
3. âœ… **CPUå ç”¨ç‡é™ä½**ï¼šä»92.4%é™ä½è‡³30-40%
4. âœ… **è®­ç»ƒé€Ÿåº¦æå‡**ï¼šæ•°æ®åŠ è½½ä¸å†æˆä¸ºç“¶é¢ˆ
5. âœ… **æ¶ˆé™¤è­¦å‘Šä¿¡æ¯**ï¼šæ— NumPyåªè¯»è­¦å‘Šå’ŒTensorè½¬æ¢è­¦å‘Š

---

## éªŒè¯ç»“æœ

è¿è¡ŒéªŒè¯è„šæœ¬ï¼š
```bash
python verify_data.py --image_size 224 --check_samples 20 --verbose
```

**éªŒè¯é€šè¿‡**ï¼š
- è®­ç»ƒé›†ï¼š50,000æ ·æœ¬ï¼Œå½¢çŠ¶æ­£ç¡®ï¼Œå€¼èŒƒå›´[0.0, 1.0]
- æµ‹è¯•é›†ï¼š10,000æ ·æœ¬ï¼Œå½¢çŠ¶æ­£ç¡®ï¼Œå€¼èŒƒå›´[0.0, 1.0]
- ç±»åˆ«åˆ†å¸ƒï¼šå®Œå…¨å¹³è¡¡ï¼ˆæ¯ç±»5000/1000æ ·æœ¬ï¼‰
- æ— NaNæˆ–Infå€¼

---

## æŠ€æœ¯è¦ç‚¹æ€»ç»“

1. **Memmap vs NumPyæ•°ç»„**ï¼šé¢„å¤„ç†æ—¶ä½¿ç”¨memmapåˆ›å»ºçš„æ–‡ä»¶å¿…é¡»ç”¨memmapæ–¹å¼è¯»å–
2. **DataLoaderä¼˜åŒ–**ï¼šåˆç†è®¾ç½®num_workerså¯æ˜¾è‘—æå‡æ•°æ®åŠ è½½æ•ˆç‡
3. **å†…å­˜ç®¡ç†**ï¼špin_memoryå¯åŠ é€ŸGPUæ•°æ®ä¼ è¾“ï¼Œä½†ä¼šå ç”¨æ›´å¤šç³»ç»Ÿå†…å­˜
4. **é¿å…é‡å¤è½¬æ¢**ï¼šæ•°æ®å·²ç»æ˜¯Tensoræ—¶ï¼Œä¸è¦å†ä½¿ç”¨torch.tensor()

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2026å¹´1æœˆ6æ—¥  
**ä¿®å¤äººå‘˜**ï¼šCascade AI Assistant  
**çŠ¶æ€**ï¼šâœ… å·²è§£å†³