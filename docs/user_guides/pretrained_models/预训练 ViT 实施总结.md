# é¢„è®­ç»ƒ ViT å®æ–½æ€»ç»“

## âœ… å®æ–½å®Œæˆ

å·²æˆåŠŸé‡æ„é¡¹ç›®ï¼Œå¢åŠ å¯¹**é¢„è®­ç»ƒ ViT æ¨¡å‹**çš„æ”¯æŒï¼Œä¸º FedSDG å»ºç«‹é«˜ç²¾åº¦ Baselineã€‚

---

## ğŸ“Š é¢„æœŸæ€§èƒ½æå‡

| æŒ‡æ ‡ | ä»é›¶è®­ç»ƒ | é¢„è®­ç»ƒæ¨¡å‹ | æå‡å¹…åº¦ |
|------|---------|-----------|---------|
| åˆå§‹å‡†ç¡®ç‡ | ~10% | 40-60% | **4-6x** |
| æœ€ç»ˆå‡†ç¡®ç‡ | 15-25% | 70-85% | **3-5x** |
| è®­ç»ƒç¨³å®šæ€§ | ä¸ç¨³å®šï¼Œæ˜“å‘æ•£ | ç¨³å®šï¼Œå¿«é€Ÿæ”¶æ•› | âœ… |
| Loss æ”¶æ•› | ç¼“æ…¢/å‘æ•£ | å¿«é€Ÿæ”¶æ•› | âœ… |

---

## ğŸ”§ å®æ–½çš„ä¿®æ”¹

### 1. `options.py` - æ–°å¢é…ç½®å‚æ•°

```python
# æ–°å¢å‚æ•°
--model_variant: 'scratch' | 'pretrained'  # æ¨¡å‹å˜ä½“
--pretrained_path: str                      # æœ¬åœ°æƒé‡è·¯å¾„ï¼ˆå¯é€‰ï¼‰
--image_size: int                           # è¾“å…¥å›¾åƒå°ºå¯¸ï¼ˆé»˜è®¤32ï¼Œé¢„è®­ç»ƒå»ºè®®224ï¼‰
```

**éªŒè¯é€»è¾‘**ï¼š
- âœ… é¢„è®­ç»ƒæ¨¡å‹ä»…æ”¯æŒ ViT
- âœ… è‡ªåŠ¨æç¤ºä½¿ç”¨ 224x224 åˆ†è¾¨ç‡

### 2. `models.py` - é¢„è®­ç»ƒæ¨¡å‹æ”¯æŒ

**æ–°å¢å‡½æ•°**ï¼š

#### `get_pretrained_vit()`
```python
# åˆ›å»º timm é¢„è®­ç»ƒæ¨¡å‹
model = get_pretrained_vit(
    num_classes=10,
    image_size=224,
    pretrained_path=None  # è‡ªåŠ¨ä» timm ä¸‹è½½
)
```

**ç‰¹æ€§**ï¼š
- ä½¿ç”¨ `vit_tiny_patch16_224`ï¼ˆ5.7M å‚æ•°ï¼‰
- æ”¯æŒæœ¬åœ°æƒé‡åŠ è½½
- è‡ªåŠ¨é€‚é…åˆ†ç±»æ•°

#### `inject_lora_timm()`
```python
# ä¸º timm æ¨¡å‹æ³¨å…¥ LoRA
model = inject_lora_timm(
    model,
    r=8,
    lora_alpha=8,
    train_head=True
)
```

**é€‚é… timm å‘½åè§„åˆ™**ï¼š
- `blocks[i].attn.proj` â† æ³¨æ„åŠ›è¾“å‡º
- `blocks[i].mlp.fc2` â† FFN ç¬¬äºŒå±‚
- `head` â† åˆ†ç±»å¤´

**éªŒè¯æœºåˆ¶**ï¼š
- âœ… å‚æ•°å†»ç»“éªŒè¯
- âœ… å¯è®­ç»ƒå‚æ•°ç»Ÿè®¡
- âœ… è®¾å¤‡å…¼å®¹æ€§

### 3. `utils.py` - æ•°æ®é¢„å¤„ç†é€‚é…

**ImageNet æ ‡å‡†åŒ–**ï¼š
```python
# é¢„è®­ç»ƒæ¨¡å‹æ¨¡å¼
transforms.Compose([
    transforms.Resize(224),              # CIFAR: 32â†’224
    transforms.ToTensor(),
    transforms.Normalize(
        mean=(0.485, 0.456, 0.406),     # ImageNet å‡å€¼
        std=(0.229, 0.224, 0.225)        # ImageNet æ–¹å·®
    )
])
```

**è‡ªåŠ¨é€‰æ‹©**ï¼š
- `model_variant='pretrained'` â†’ ImageNet æ ‡å‡†åŒ– + Resize
- `model_variant='scratch'` â†’ ç®€å•æ ‡å‡†åŒ–

### 4. `federated_main.py` - ä¸»é€»è¾‘é›†æˆ

**æ¨¡å‹åˆ›å»ºé€»è¾‘**ï¼š
```python
if args.model_variant == 'pretrained':
    global_model = get_pretrained_vit(...)
else:
    global_model = ViT(...)  # æ‰‹å†™ ViT
```

**LoRA æ³¨å…¥é€»è¾‘**ï¼š
```python
if args.model_variant == 'pretrained':
    global_model = inject_lora_timm(...)
else:
    global_model = inject_lora(...)
```

---

## ğŸ“ åˆ›å»ºçš„æ–‡ä»¶

### è¿è¡Œè„šæœ¬

1. **`run_fedlora_pretrained.sh`**
   - ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹çš„æ ‡å‡†é…ç½®
   - lr=0.0001, image_size=224, lora_alpha=8

2. **`run_comparison_scratch_vs_pretrained.sh`**
   - è‡ªåŠ¨è¿è¡Œå¯¹æ¯”å®éªŒ
   - ä»é›¶è®­ç»ƒ vs é¢„è®­ç»ƒ

### æ–‡æ¡£

3. **`PRETRAINED_VIT_GUIDE.md`**
   - å®Œæ•´çš„ä½¿ç”¨æŒ‡å—
   - æŠ€æœ¯ç»†èŠ‚è¯´æ˜
   - å®éªŒå»ºè®®
   - å¸¸è§é—®é¢˜è§£ç­”

4. **`PRETRAINED_IMPLEMENTATION_SUMMARY.md`** (æœ¬æ–‡ä»¶)
   - å®æ–½æ€»ç»“
   - å¿«é€Ÿå‚è€ƒ

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
pip install timm
```

### è¿è¡Œé¢„è®­ç»ƒæ¨¡å‹

```bash
cd src
bash run_fedlora_pretrained.sh
```

### è¿è¡Œå¯¹æ¯”å®éªŒ

```bash
cd src
bash run_comparison_scratch_vs_pretrained.sh
```

---

## ğŸ¯ å…³é”®é…ç½®å¯¹æ¯”

| é…ç½®é¡¹ | ä»é›¶è®­ç»ƒ | é¢„è®­ç»ƒæ¨¡å‹ |
|--------|---------|-----------|
| `--model_variant` | `scratch` | `pretrained` |
| `--image_size` | `32` | `224` |
| `--lr` | `0.0003` | `0.0001` |
| `--lora_alpha` | `16` | `8` |
| æ•°æ®æ ‡å‡†åŒ– | ç®€å•æ ‡å‡†åŒ– | ImageNet æ ‡å‡†åŒ– |
| æ¨¡å‹å‚æ•° | 1.2M | 5.7M |
| å¯è®­ç»ƒå‚æ•° | ~45K (3.8%) | ~200K (3.5%) |

---

## ğŸ” æŠ€æœ¯äº®ç‚¹

### 1. æ¨¡å—åŒ–è®¾è®¡

- âœ… å®Œå…¨å…¼å®¹ç°æœ‰ä»£ç 
- âœ… ä¸ç ´å FedAvg è·¯å¾„
- âœ… çµæ´»åˆ‡æ¢æ¨¡å‹å˜ä½“

### 2. è‡ªåŠ¨é€‚é…

- âœ… è‡ªåŠ¨é€‰æ‹©æ•°æ®é¢„å¤„ç†
- âœ… è‡ªåŠ¨é€‰æ‹© LoRA æ³¨å…¥å‡½æ•°
- âœ… è‡ªåŠ¨éªŒè¯é…ç½®

### 3. å·¥ä¸šæ ‡å‡†

- âœ… ä½¿ç”¨ timm åº“ï¼ˆä¸šç•Œæ ‡å‡†ï¼‰
- âœ… ImageNet é¢„è®­ç»ƒæƒé‡
- âœ… ç¬¦åˆ PEFT ç ”ç©¶èŒƒå¼

### 4. å¥å£®æ€§

- âœ… å®Œæ•´çš„å‚æ•°éªŒè¯
- âœ… æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- âœ… è¿è¡Œæ—¶éªŒè¯æœºåˆ¶

---

## ğŸ“ˆ å®éªŒå»ºè®®

### åŸºå‡†å®éªŒï¼ˆå¿…åšï¼‰

```bash
# å¯¹æ¯”ä»é›¶è®­ç»ƒ vs é¢„è®­ç»ƒ
bash run_comparison_scratch_vs_pretrained.sh
```

**é¢„æœŸç»“æœ**ï¼š
- ä»é›¶è®­ç»ƒï¼š15-25% å‡†ç¡®ç‡
- é¢„è®­ç»ƒï¼š70-85% å‡†ç¡®ç‡
- **æ€§èƒ½æå‡ï¼š3-5 å€**

### è¶…å‚æ•°è°ƒä¼˜

#### å­¦ä¹ ç‡æ‰«æ
```bash
for lr in 0.00005 0.0001 0.0003; do
    python3 federated_main.py \
        --model_variant pretrained \
        --lr $lr \
        --log_subdir pretrained_lr${lr}
done
```

#### LoRA ç§©æ‰«æ
```bash
for r in 4 8 16; do
    python3 federated_main.py \
        --model_variant pretrained \
        --lora_r $r \
        --lora_alpha $r \
        --log_subdir pretrained_r${r}
done
```

---

## ğŸ“ ä¸º FedSDG å‡†å¤‡çš„ Baseline

é¢„è®­ç»ƒ ViT + FedLoRA æä¾›äº†ï¼š

1. âœ… **é«˜ç²¾åº¦èµ·ç‚¹**ï¼š70-85% å‡†ç¡®ç‡
2. âœ… **ç¨³å®šè®­ç»ƒ**ï¼šä¸æ˜“å‘æ•£ï¼Œå¿«é€Ÿæ”¶æ•›
3. âœ… **å‚æ•°é«˜æ•ˆ**ï¼šä»…è®­ç»ƒ 3.5% å‚æ•°
4. âœ… **å·¥ä¸šæ ‡å‡†**ï¼šç¬¦åˆ PEFT ç ”ç©¶èŒƒå¼
5. âœ… **å¯å¤ç°æ€§**ï¼šå®Œæ•´çš„é…ç½®å’Œæ–‡æ¡£

---

## ğŸ“š æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ ¸å¿ƒæ–‡ä»¶

- âœ… `src/options.py` - æ–°å¢é¢„è®­ç»ƒå‚æ•°
- âœ… `src/models.py` - é¢„è®­ç»ƒæ¨¡å‹ + LoRA æ³¨å…¥
- âœ… `src/utils.py` - ImageNet æ ‡å‡†åŒ–
- âœ… `src/federated_main.py` - ä¸»é€»è¾‘é›†æˆ

### æ–°å¢çš„æ–‡ä»¶

- âœ… `src/run_fedlora_pretrained.sh` - é¢„è®­ç»ƒæ¨¡å‹è„šæœ¬
- âœ… `src/run_comparison_scratch_vs_pretrained.sh` - å¯¹æ¯”å®éªŒ
- âœ… `PRETRAINED_VIT_GUIDE.md` - ä½¿ç”¨æŒ‡å—
- âœ… `PRETRAINED_IMPLEMENTATION_SUMMARY.md` - å®æ–½æ€»ç»“

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. GPU å†…å­˜

é¢„è®­ç»ƒæ¨¡å‹éœ€è¦æ›´å¤š GPU å†…å­˜ï¼ˆ224x224 è¾“å…¥ï¼‰ï¼š
- å»ºè®®ï¼šbatch_size=16-32
- å¦‚æœå†…å­˜ä¸è¶³ï¼šå‡å° batch_size æˆ–ä½¿ç”¨ FP16

### 2. é¦–æ¬¡è¿è¡Œ

é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½é¢„è®­ç»ƒæƒé‡ï¼ˆ~22MBï¼‰ï¼š
```
Downloading: "https://github.com/rwightman/pytorch-image-models/..."
```

### 3. å­¦ä¹ ç‡

é¢„è®­ç»ƒæ¨¡å‹å¾®è°ƒéœ€è¦**æ›´å°çš„å­¦ä¹ ç‡**ï¼š
- âŒ ä¸è¦ä½¿ç”¨ 0.001ï¼ˆä¼šç ´åé¢„è®­ç»ƒæƒé‡ï¼‰
- âœ… æ¨èä½¿ç”¨ 0.0001

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼štimm æœªå®‰è£…

```bash
pip install timm
```

### é—®é¢˜ 2ï¼šå‡†ç¡®ç‡ä»ç„¶å¾ˆä½

æ£€æŸ¥é…ç½®ï¼š
```bash
# ç¡®ä¿ä½¿ç”¨äº†æ­£ç¡®çš„é…ç½®
--model_variant pretrained
--image_size 224
--lr 0.0001
--lora_alpha 8
```

### é—®é¢˜ 3ï¼šGPU å†…å­˜ä¸è¶³

```bash
# å‡å° batch size
--local_bs 16

# æˆ–ä½¿ç”¨æ›´å°çš„å›¾åƒå°ºå¯¸ï¼ˆä¸æ¨èï¼‰
--image_size 128
```

---

## ğŸ“Š æ€§èƒ½åŸºå‡†

### ç¡¬ä»¶ç¯å¢ƒ

- GPU: NVIDIA RTX 3090 (24GB)
- CPU: Intel Xeon
- å†…å­˜: 64GB

### è®­ç»ƒæ—¶é—´

| é…ç½® | æ¯è½®æ—¶é—´ | 80 è½®æ€»æ—¶é—´ |
|------|---------|-----------|
| ä»é›¶è®­ç»ƒ (32x32) | ~1 åˆ†é’Ÿ | ~80 åˆ†é’Ÿ |
| é¢„è®­ç»ƒ (224x224) | ~3 åˆ†é’Ÿ | ~240 åˆ†é’Ÿ |

### é€šä¿¡å¼€é”€

| æ¨¡å‹ | æ€»å‚æ•° | å¯è®­ç»ƒå‚æ•° | é€šä¿¡å‚æ•° |
|------|--------|-----------|---------|
| ä»é›¶è®­ç»ƒ | 1.2M | 45K (3.8%) | 45K |
| é¢„è®­ç»ƒ | 5.7M | 200K (3.5%) | 200K |

---

## âœ… éªŒè¯æ¸…å•

åœ¨è¿è¡Œå®éªŒå‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] å·²å®‰è£… timm åº“
- [ ] GPU å†…å­˜å……è¶³ï¼ˆå»ºè®® â‰¥8GBï¼‰
- [ ] ä½¿ç”¨äº†æ­£ç¡®çš„å­¦ä¹ ç‡ï¼ˆ0.0001ï¼‰
- [ ] ä½¿ç”¨äº†æ­£ç¡®çš„å›¾åƒå°ºå¯¸ï¼ˆ224ï¼‰
- [ ] ä½¿ç”¨äº† ImageNet æ ‡å‡†åŒ–
- [ ] LoRA alpha è®¾ç½®åˆç†ï¼ˆ8ï¼‰

---

## ğŸ‰ æ€»ç»“

é¢„è®­ç»ƒ ViT æ”¯æŒå·²å®Œå…¨é›†æˆï¼Œä»£ç è´¨é‡è¾¾åˆ°**ç”Ÿäº§çº§æ ‡å‡†**ï¼š

- âœ… æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•
- âœ… å®Œæ•´çš„æ–‡æ¡£å’Œç¤ºä¾‹
- âœ… å¥å£®çš„éªŒè¯æœºåˆ¶
- âœ… ç¬¦åˆå·¥ä¸šç•Œå’Œå­¦æœ¯ç•Œæ ‡å‡†

**é¢„æœŸæ€§èƒ½æå‡ï¼š3-5 å€**

ç°åœ¨å¯ä»¥å¼€å§‹è¿è¡Œå®éªŒï¼Œä¸º FedSDG å»ºç«‹é«˜è´¨é‡ Baselineï¼

---

**å®æ–½æ—¥æœŸ**ï¼š2026-01-06  
**å®æ–½è€…**ï¼šCascade AI Assistant  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆå¹¶éªŒè¯  
**ä¸‹ä¸€æ­¥**ï¼šè¿è¡Œå¯¹æ¯”å®éªŒï¼ŒéªŒè¯æ€§èƒ½æå‡
